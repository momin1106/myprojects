KISSY.use("event, node, dom, register/components/xerror, register/components/password, register/components/repassword, register/components/message, register/utils/messages, register/components/nicksize, register/components/nick, register/components/similar",function(a){var b=window.TRConfig,c=window.TRLang||{},d=a.require("register/components/password"),e=a.require("register/components/repassword"),f=a.require("register/components/nicksize"),g=a.require("register/components/nick"),h=a.require("register/components/similar"),i=a.require("register/components/xerror"),j=a.require("register/components/message"),k=a.require("register/utils/messages"),l=d({el:"#J_Password"}),m=e({elPassword:"#J_Password",elRePassword:"#J_RePassword"}),n=k({messages:{password:j({el:"#J_MsgPassword",offsetEl:"#J_Password",offset:{top:8}}),repassword:j({el:"#J_MsgRePassword",offsetEl:"#J_RePassword",offset:{top:8}}),infoForm:j({el:"#J_MsgInfoForm"}),nick:j({el:"#J_MsgNick",offsetEl:"#J_Nick",offset:{top:8}})}});a.all("#J_Password").on("focus",function(){n.messages.password.hide(),a.one("#J_Password").removeClass("err-input"),l.showTip()}).on("blur",function(){n.messages.infoForm.hide(),l.hideTip(),l.validate().then(function(b){n.messages.password.set({type:"ok",display:"inline",content:(c.r_ui_pwd_strength||"安全程度")+"："+l.strengthText()}).show(),a.one("#J_Password").removeClass("err-input")}).fail(function(b){n.messages.password.set({type:"error",display:"inline",content:b.message||"密码设置不符合要求"}).show(),a.one("#J_Password").addClass("err-input")}),a.all("#J_RePassword").val()?m.validate().then(function(){n.messages.repassword.set({type:"ok",display:"inline"}).show(),a.one("#J_RePassword").removeClass("err-input")}).fail(function(b){n.messages.repassword.set({type:"error",display:"inline",content:b.message}).show(),a.one("#J_RePassword").addClass("err-input")}):(n.messages.repassword.hide(),a.one("#J_RePassword").removeClass("err-input"))}).on("valuechange",function(){a.all("#J_Password").val()?l.updateTip():l.resetTip()}),a.all("#J_RePassword").on("focus",function(){var b=a.one("#J_RePassword").attr("placeholder");b&&n.messages.repassword.set({type:"info",display:"inline",content:b}).show()}).on("blur",function(){return n.messages.infoForm.hide(),a.all("#J_Password").val()||a.all("#J_RePassword").val()?void m.validate().then(function(){n.messages.repassword.set({type:"ok",display:"inline",content:""}).show(),a.one("#J_RePassword").removeClass("err-input")}).fail(function(b){n.messages.repassword.set({type:"error",display:"inline",content:b.message}).show(),a.one("#J_RePassword").addClass("err-input")}):void n.messages.repassword.hide()});var o=f({el:"#J_Nick",container:"#J_NickSize"}),p=g({el:"#J_Nick"}).on("select",function(){n.messages.nick.set({type:"ok",display:"inline",content:""}).show(),a.one("#J_Nick").removeClass("err-input"),o.update()});a.all("#J_Nick").on("focus",function(){var b=a.one("#J_Nick").attr("data-outer_placeholder");b&&n.messages.nick.set({type:"info",display:"inline",content:c[b]}).show()}).on("blur",function(){n.messages.infoForm.hide();var b=a.one("#J_Password").val(),d=a.one("#J_Nick").val();return b&&d&&h(b,d)>=.8?(n.messages.nick.set({type:"error",display:"inline",content:c.ERROR_PASSWORD_LIKE_NICK||"密码和账户名太相似"}).show(),void a.one("#J_Nick").addClass("err-input")):void p.validate().then(function(){n.messages.nick.set({type:"ok",display:"inline",content:""}).show(),a.one("#J_Nick").removeClass("err-input")}).fail(function(b){n.messages.nick.set({type:"error",display:"inline",content:b.message||"用户名填写有误"}).show(),a.one("#J_Nick").addClass("err-input")})});var q;a.all("#J_InfoForm").on("submit",function(d){d.halt(),q||l.validate().then(function(b){n.messages.password.set({type:"ok",display:"inline",content:(c.r_ui_pwd_strength||"安全程度")+"："+l.strengthText()}).show(),a.one("#J_Password").removeClass("err-input")}).then(function(){return m.validate()}).then(function(){a.one("#J_RePassword").removeClass("err-input");var b=a.one("#J_Password").val(),d=a.one("#J_Nick").val();if(b&&d&&h(b,d)>=.8)throw new i("SimilarInvalid",c.ERROR_PASSWORD_LIKE_NICK||"密码和账户名太相似")}).then(function(){return p.validate(!0)}).then(function(){a.one("#J_Nick").removeClass("err-input"),a.IO({type:"post",url:b.submitUserUrl,dataType:"json",form:a.one("#J_InfoForm"),timeout:5,complete:function(a){return a&&a.success?void(a.loc&&(window.location.href=a.loc)):(n.messages.infoForm.set({type:"error",content:c[a.reason]||"系统错误，请稍后重试",display:"block"}).show(),void(q=!1))}}),q=!0}).fail(function(b){switch(b.code){case"PasswordInvalid":n.messages.password.set({type:"error",display:"inline",content:b.message||"密码设置不符合要求"}).show(),a.one("#J_Password").addClass("err-input");break;case"RePasswordInvalid":n.messages.repassword.set({type:"error",display:"inline",content:b.message||"密码输入不一致"}).show(),a.one("#J_RePassword").addClass("err-input");break;case"NickInvalid":case"NickError":case"SimilarInvalid":n.messages.nick.set({type:"error",display:"inline",content:b.message||"用户名填写有误"}).show(),a.one("#J_Nick").addClass("err-input");break;default:n.messages.infoForm.set({type:"error",display:"inline",content:b.message||"信息输入有误，请重新输入！"}).show()}})})});
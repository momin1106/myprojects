KISSY.add("kg/search-suggest/6.0.23/plugin/cloud",["base","dom","node","event","cookie","kg/search-suggest/6.0.23/mods/menu","kg/search-suggest/6.0.23/tpl/cloud"],function(e,t,n,a){function o(e){o.superclass.constructor.call(this,e||{})}var r,i,s,l=t("base"),u=t("dom"),d=t("node"),c=t("event"),h=(t("cookie"),t("kg/search-suggest/6.0.23/mods/menu")),g=t("kg/search-suggest/6.0.23/tpl/cloud"),m=d.all;KISSY.extend(o,l,{pluginInitializer:function(e){var t,n,a=this,o=e.comboBox;a.isNotFirstRender=[],a.count=0,r=e,i=a.Utils,s=a.Stat,a.set("caller",e),a.initKeyEvent();var l=u.children(e.get("el")),c=e.get("form")[0],g=u.attr(c,"action"),m=u.attr(l,"data-action")||e.get("action")||g;a.set("action",m),o.on("beforeShow",function(){if(a.isShowFirstItem){var e=o.get("menu"),t=e.get("children");e.set("highlightedItem",t[0]),a.show(t[0].get("el")[0])}else a.setCloudHeight()}),e.on("afterCollapsedChange",function(o){o.newVal||(e.detach("afterCollapsedChange",arguments.callee),a.mouseArr=[],n=e.get("menu"),t=n.get("el"),t.addClass("search-cloud-menu"),a.initMenu||(d.one(".search-menu")&&(a.initMenu=!0,a.menu=new h({wrap:".search-menu",menu:".search-contentbox,.search-menu-content",rows:".search-menuitem",cls:".search-wrap-cloud",tolerance:500,handler:{enterHandler:function(t){e.fire("beforeCloudShow",{inst:a,el:t})!==!1&&a.show(t)},leaveHandler:function(e){a.hide(e)}}})),n.on("afterHighlightedItemChange",function(){a.setCloudHeight()}),a.initMouseEvent(t)))})},initMouseEvent:function(e){return e?void e.delegate("click",".cloud-list a",function(e){var t=e.currentTarget,n=t.getAttribute("href");n&&(n=r.urlEncode(n),t.setAttribute("href",n))}):!1},show:function(e){var t=this;t._showCloud(e),t.setCloudHeight()},hide:function(){this._hideCloud()},setCloudHeight:function(){var e,t=r.get("menu").get("el"),n=d.one(".cloud-footer");if(t.width()<500?t.addClass("narrow-suggest-menu"):t.removeClass("narrow-suggest-menu"),n){if(e=n.one(".cloud-box"),e.css("height","auto"),t.css("height","auto"),e){var a=t.height(),o=e.height();o>a?t.height(o-1):(t.css("height","auto"),e.css("height","100%"))}}else t.css("height","auto")},_hideCloud:function(){m(".cloud-footer").hide(),m(".search-menu-item-hover").removeClass("search-menu-item-hover")},_showCloud:function(e){var t,n,a,o=this,r=m(".search-wrap-cloud",e),i=d.one(".cloud-footer");m(".search-menu-item-hover").removeClass("search-menu-item-hover"),m(e).addClass("search-menu-item-hover"),o.lastItemIndex&&(n=d.one("#J_CloudList"+o.lastItemIndex),n&&n.hide(),i&&i.hide()),r.length&&(t=r.attr("data-index")||r.one("div").attr("data-index"),o.lastItemIndex=t,n=d.one("#J_CloudList"+t),n&&(a=n.attr("data-align"),o.set("align",!("true"!==a)),n.show(),i&&i.show(),o.setPadding(m(e),n)))},_sendStat:function(){var e="f_stats_show=magic:1",t=r.get("sugConfig").sourceUrl,n="";t&&t.match(/bucketid=\w+/)&&(n=t.match(/bucketid=(\w+)/)[1],e+=";bts:"+n),s&&s.send(e,!0)},getPadding:function(e,t){var n=32,a=d.one(".search-menu"),o=a.offset().top,r=e.offset().top,i=r-o,s=a.height(),l=t.height(),u=i-n,c=s-l-u-10;return u>0?c>=0?u:u-=39*Math.round(-c/39):void 0},initKeyEvent:function(){var e=this,t=r.comboBox,n=c.KeyCodes||d.KeyCode;t.on("beforeKeyDown",function(a){var o=this.get("menu");if(o.get){var i,s,l,u,c=a.event,h=o.get("highlightedItem"),g=o.get("children"),m=g.length;if(0===m)return void 0;switch(c.keyCode){case n.ENTER:var v=e.isShowMagic(),f=e.isShowItem(),p=v||f;return p&&(c.halt(),!v&&f&&(KISSY.UA.ie>=10||0===KISSY.version.indexOf("6."))?h.fire("click"):p.click()),!1;case n.UP:case n.DOWN:var w,S;c.keyCode===n.UP?(S=m-1,w=-1):(S=0,w=1),e.isTriggerArrowKey=!0,h?(i=KISSY.indexOf(h,g),s=(i+w+m)%m):s=S;var I=d.one(".cloud-link-wrap-hover");return I&&I.removeClass("cloud-link-wrap-hover"),0===i&&-1===w||i===m-1&&1===w?(e._hideCloud(),o.set("highlightedItem",null),t._stopNotify=1,r.get("input").val(t._savedInputValue||t._savedValue),!1):(l=o._getNextEnabledHighlighted(s,w),o.set("highlightedItem",l),e.show(l.get("el")[0]),t._stopNotify=1,u=l.get("textContent"),t.setValueFromAutocomplete?t.setValueFromAutocomplete(u):(t._stopNotify=1,r.get("input").val(u)),t.fire("beforeSetInputValue",{event:c}),!1);case n.HOME:case n.END:return l=c.keyCode===n.END?o._getNextEnabledHighlighted(m-1,-1):o._getNextEnabledHighlighted(0,1),o.set("highlightedItem",l),e._showCloud(l.get("el")[0]),t.setValueFromAutocomplete?t.setValueFromAutocomplete(l.get("textContent")):(t._stopNotify=1,r.get("input").val(l.get("textContent"))),!1;default:e.directionEvent(c)}}})},isShowMagic:function(){var e,t,n,a=m(".J_cloud-handle");return a.each(function(t){var n=d.all(t);"none"!==u.css(n,"display")&&(e=n)}),e?(t=u.query(".cloud-link-wrap-hover")[0],t&&(n="a"===t.tagName.toLowerCase()?t:u.query("a",t)[0]),n):void 0},isShowItem:function(){var e=this;return e.isTriggerArrowKey&&u.get(".search-menu-item-hover")},directionEvent:function(e){var t,n,a,o,i,s=this;switch(e.keyCode){case 39:case 37:if(i=r.get("menu"),t=i.get("activeItem")||i.get("highlightedItem"),!t)return!0;if(n=t.get("el").one(".item-wrapper"),!n)return!0;if(a=n.attr("data-index"),!a)return!0;if(o=d.one("#J_CloudList"+a),!o)return!0;var l=e.keyCode-37?"next":"prev";s.getHighLightItem(o,l)}},getHighLightItem:function(e,t){var n=e.one(".cloud-link-wrap-hover");if(n){var a=parseInt(e.attr("data-select-index")),o=e.all(".cloud-link");a="next"==t?a<o.length-1?a+1:0:a>0?a-1:o.length-1,n.removeClass(".cloud-link-wrap-hover");var r=o.item(a);e.attr("data-select-index",a),r.parent().addClass("cloud-link-wrap-hover")}else{var i=e.one(".cloud-link").parent();i&&i.addClass("cloud-link-wrap-hover"),e.attr("data-select-index",0)}},setPadding:function(e,t){var n=this,a=t.one(".inner-wrap"),o=this.getPadding(e,a),r=n.get("align");r&&o&&a.css("paddingTop",o)},checkRender:function(e){var t,n=this,a=e.comboBox,o=e.query,r=a.get("dataSource"),i=r.extraData[o],s=e.resultArr;return t=""!==o&&i?{extra:i,query:o,results:s}:!1,n.extraData=i,n.isShowFirstItem=!1,t},isAutoShow:function(e){return!!(KISSY.isArray(e)&&e.length>0&&(e[0].list||e[0].tag))},renderPlugin:function(){var e=this,t=e.checkRender(r);if(!t)return!1;var n,a,o,i,s,l,u,d,c="",h=t.extra,g=t.results,m=t.query;e.isFirstShow=!1,n=KISSY.clone(h.magic);for(var v=e.isAutoShow(r.resultArr),f=0,p=g.length-1;p>=f;f++)if(a=g[f],s=a.content,o=s.match(/data-index='(\w+)'/),i=s.match(/data-key='([\S\s]+?)'/),o&&o[1]){o=o[1]-0,i&&i[1]&&(i=i[1]);for(var w in n)l=n[w],o===l.index-0&&(e._wrapItem(a,i),d=e._renderHTML({data:l,query:m,index:o,key:i,auto:v,type:l.type||"tag",tagTitle:decodeURIComponent(i.match(/q=([^&]+)/)[1]),action:e.get("action")}),d&&(c+=d),1===o&&d&&(u=!0))}var S={tmpl:'<div class="cloud-box">'+c+"</div>",type:"cloud"};if(v&&u?(S.css={display:"block"},e.isShowFirstItem=!0):(S.css={display:"none"},e.isShowFirstItem=!1),KISSY.UA.ie<7){var I=r.resultArr.length;S.css.height=26*I}r.__footer=S,r._addExtraEvent(),e.isTriggerArrowKey=!1},_wrapItem:function(e,t){var n;KISSY.isObject(e)&&(n=e.content,e.content="<div class='search-wrap-cloud' data-key='"+t+"'>"+n+"</div>")},_renderHTML:function(e){var t,n,a,o=this,r={},i=e.data,s=e.query,l=e.index,u=o.extraData,d=e.type,c=e.auto&&1===l?"style='display:block'":"";if(u&&u.event&&1===l)t=o.get("event-tmpl"),n=o.get("event-param");else{if(!d)return KISSY.log("魔盒类型不存在!"),c="",!1;if(a=o.get(d),!a)return KISSY.log("接口返回的类型"+d+"不存在对应的模板"),c="",!1;t=a.tmpl,a.length&&i.data&&i.data.length>a.length&&(i.data.length=a.length),a.sort&&o.sort(i.data),n=o.get("param")}r.param=n?"&"+n:"",r.query=s,r.index=l,r.prefix=e.prefix||l,r.tagTitle=e.tagTitle,r.action=e.action,i.count&&i.count<=3&&(r.ishidden="hidden"),r=KISSY.merge(r,i),r.autoAttr=c;var h=t(r);return h},sort:function(e){Array.prototype.sort.call(e,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(e){return KISSY.isNumber(e)?e:void 0}},tag:{value:{tmpl:g.tag,sort:!0,length:10}},tag_group:{value:{tmpl:g.tag_group,length:10}},navi:{value:{tmpl:g.navi}},spu:{value:{tmpl:g.spu,length:3}},topbrand:{value:{tmpl:g.topbrand}},qrcode:{value:{tmpl:g.qrcode}},align:{value:!0}}}),a.exports=o});
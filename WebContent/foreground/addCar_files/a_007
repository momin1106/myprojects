KISSY.add("tbc/search-suggest/1.4.5/mods/local-query",["base","json","../mods/storage"],function(t,e,a,s){function n(t){n.superclass.constructor.call(this,t||{}),this.initialize()}var i=e("base"),r=e("json"),o=e("../mods/storage"),u="localQuery";t.extend(n,i,{initialize:function(){var t=this,e=t.get("name"),a=t.get("tab"),s=t.get("user");"item"===a&&(a="baobei"),t.storageKey=u+e+a+s,t._getStorage()},checkFlash:function(t){this.storage.read(t)},_setKey:function(t){var e=this,a=t.name||e.get("name"),s=t.tab||e.get("tab"),n=t.user||e.get("user");"item"===s&&(s="baobei"),e.storageKey=u+a+s+n,e.set("tab",s),e.set("name",a),e.set("user",n),this.datalist=null},_save:function(e,a){if(!e.match(/<>'"/)&&!a.match(/<>'"/)){var s=this._getDatalist(),n=encodeURIComponent(e),i={key:n,value:encodeURIComponent(a),time:t.now()};this._deleteItemByValue(s,n),s.unshift(i)}},_deleteItemByValue:function(t,e){for(var a,s=null,n=0;n<t.length;n++)a=t[n].key,a==e&&(s=t.splice(n,1),n--)},_query:function(e){var a,s,n=this._getDatalist(),i=[];return e?(e=encodeURIComponent(e),t.each(n,function(t,n){a=t.key,s=t.value,(0===a.indexOf(e)||0===s.indexOf(e))&&i.push(t)}),this._distinctByValue(i)):this._distinctByValue(n)},_distinctByValue:function(t){for(var e,a=[],s=0,n=t.length;n>s;s++)e=t[s],e.value.match(/%3C|%3E|[<>'"]/g)||!this._hasItemOfValue(a,e.value)&&a.push(e);return a},_hasItemOfValue:function(t,e){for(var a=!1,s=t.length-1;s>=0;s--)t[s].value===e&&(a=!0);return a},_cleanBefore:function(t){for(var e,a=this._getDatalist(),s=0,n=a.length-1;n>=0;n--)if(e=a[n],e.time>t){s=n+1;break}a.length=s},_getDatalist:function(){return this.datalist||(this.datalist=this.storage.read()||[]),this.datalist},_getStorage:function(){var t=this.get("storageType");switch(t){case"flashStorage":this.storage=this._initFlashStorage();break;default:this.storage=!1}},_initFlashStorage:function(){var t=this;return{save:function(){return(new o).save(t.storageKey,r.stringify(t.datalist))},read:function(e){var a=(new o).read(t.storageKey,e);if(a){var s=r.parse(a);return s}return void 0}}},destructor:function(){this.datalist=null,u=null},save:function(e,a){if(""!=a){var s,n=this.storage.read();n&&(s=n.length);var i=this._save(e,a),r=this.storage.save();return s>300&&(this.datalist=this.datalist.slice(0,s-10),t.log("add_before\n"+r+"\n"+s),r=this.storage.save(),t.log("add_after\n"+r+"\n"+s)),i}},query:function(t){return this._query(t)},deleteItem:function(e){var a=this._getDatalist(),s=a.length;this._deleteItemByValue(a,encodeURIComponent(e));var n=this.storage.save();s>300&&(this.datalist=this.datalist.slice(0,s-10),n=this.storage.save(),t.log("delete\n"+n+"\n"+s))},clearByDay:function(e){var a=t.now()-24*e*3600*1e3;this._cleanBefore(a),this.storage.save()},hasHistory:function(){return this._getDatalist().length>0?!0:!1}},{ATTRS:{name:{value:"default",setter:function(t){return t}},user:{value:"",setter:function(e){return t.fromUnicode(e)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(t){return t},getter:function(t){return t}}}}),s.exports=n});KISSY.add("tbc/search-suggest/1.4.5/mods/menu",["node"],function(e,t,n,r){t("node");var o=e.all,u=function(t){var n=this;n.opts=e.mix(u.defs,t),n.$wrap=o(n.opts.wrap),n.$menu=o(n.opts.menu),n.locs=[],n.rNow=null,n.tOut=null,n.init()};u.defs={wrap:"",menu:"",rows:"",dealy:300,handler:null,tolerance:0},u.prototype.getOffset=function(){var e=this,t=e.opts,n=e.$menu,r=n.offset();e.menuOffset=r,e.upperRight={x:r.left+n.outerWidth(),y:r.top-t.tolerance},e.lowerRight={x:r.left+n.outerWidth(),y:r.top+n.outerHeight()+t.tolerance}},u.prototype.bindEvent=function(){var e,t,n,r=this,u=r.opts,l=r.locs,a=r.rNow,i=r.tOut,s=null,f=function(i){function f(e,t){return(t.y-e.y)/(t.x-e.x)}var c=!!o(i).one(u.cls);r.getOffset(),e=r.menuOffset,t=r.upperRight,n=r.lowerRight;var p=l[l.length-1],g=l[0];if(!a||!p)return 0;if(g.x<e.left||g.x>n.x||g.y<e.top||g.y>n.y)return 0;if(s&&p.x==s.x&&p.y==s.y)return 0;var d=f(p,t),h=f(p,n),y=f(g,t),m=f(g,n);return c&&y>d&&h>m?(s=p,u.dealy):(s=null,0)},c=function(e){a!=e&&(u.handler.enterHandler(e),a=e)},p=function(e,t){r.isDelay=t?!0:!1;var n=f(t);n?i=setTimeout(function(){p(r.currentTarget,r.currentTarget)},n):(r.isDelay=!1,c(e))},g=function(e){l.push({x:e.pageX,y:e.pageY}),l.length>3&&l.shift()},d=function(){a=null,u.handler.leaveHandler()},h=function(){r.isDelay=!1,a=null,i&&clearTimeout(i)},y=function(e){if(r.currentTarget=e.currentTarget,!r.isDelay){i&&clearTimeout(i);var t=e.relatedTarget,n=o(t).parent(u.rows);p(e.currentTarget,n)}};r.$wrap.on("mousemove",g).on("mouseleave",d),r.$menu.on("mouseleave",h).delegate("mouseenter",u.rows,y)},u.prototype.init=function(){this.getOffset(),this.bindEvent()},r.exports=u});KISSY.add("tbc/search-suggest/1.4.5/tpl/cloud",[],function(a,t,l,s){s.exports={navi:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-navi-list" '+a.autoAttr+'> <div class="inner-wrap"> <a class="cloud-img-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <img src="//img.alicdn.com/tps/i1/'+a.data.logo+'_70x70.jpg" /> </a> <p>'+a.data.title+'</p> <a class="cloud-btn-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <span class="cloud-link">'+a.data.button+"</span><i>></i> </a> </div></div>";return t},qrcode:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-qrcode" '+a.autoAttr+' > <div class="inner-wrap"> <a href="'+a.data.url+'"><img src="'+a.data.image+'"/></a> </div></div>';return t},spu:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-spu-list" '+a.autoAttr+' > <div class="inner-wrap"> <ul> ',l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-img-wrap cloud-link" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <img src="//img.alicdn.com/tps/i1/'+s.pic+'_50x50.jpg" /> </a> <a class="cloud-title" title="'+s.title+'" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <span>'+s.title+'</span> </a> <p class="cloud-price '+(0===~~s.price?"cloud-hidden":"")+'">参考价:<b class="">￥'+s.price+'</b><b class="noprice">暂无</b></p> </li> ';return t+=' </ul> <p class="cloud-total '+a.ishidden+'"> <span class="total">共'+a.count+'款产品</span> <a class="more" target="_self" href="//'+a.link+"&source=suggest&suggest=spu_"+a.index+'_more">查看全部>></a> </p> </div></div>'},tag:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li><a target="_self" href="'+a.action+"?q="+a.tagTitle+" "+s+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~i+1)+"&tag="+s+a.param+'" class="cloud-link"><span>'+s+"</span></a></li> ";return t+=" </ul> </div></div>"},tag_group:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list type-taggroup" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;){s=l[i+=1],t+=' <li  class="tag-group"> <ul> ';var r=s;if(r)for(var d,u=-1,n=r.length-1;n>u;)d=r[u+=1],t+=' <li> <a target="_self" href="'+a.action+"?q="+encodeURIComponent(a.tagTitle+" "+d.title)+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~u+1)+"&tag="+d.title+a.param+'" class="cloud-link '+d.type+'"><span>'+d.title+"</span></a> </li> ";t+=" </ul> </li> "}return t+=" </ul> </div></div>"},topbrand:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-topbrand-list" '+a.autoAttr+' > <div class="inner-wrap"> <h3>“'+a.tagTitle.substr(0,11)+"”热门品牌</h3><ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-title cloud-link" href="//'+s.url+"&source=suggest&suggest=brandlist_"+a.index+"_"+(~~i+1)+'" target="_self"> <span><i class="cloud-top'+i+'">'+(~~i+1)+"</i>"+s.title+"</span> </a> </li> ";return t+=" </ul> </div></div>"}}});